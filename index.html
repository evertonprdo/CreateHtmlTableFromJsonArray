<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style/style.css">
    <script>      
        let controller = null;
        let currentPromise = null;
        
        function requestServer() {
            if (controller) {
                controller.abort();
            }

            controller = new AbortController();
            const signal = controller.signal;

            currentPromise = new Promise(async (resolve, reject) => {
                try {
                    let reponse = await fetch('server.php', { signal });
                    let data = await reponse.json();
                    resolve(data);
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('Requisição abortada');
                    } else {
                        reject(error);
                    }
                } finally {
                    controller = null;
                }
            });

            return currentPromise;
        }

        function getFetchReponse(refresh = false) {
            if (refresh) {
                currentPromise = null;
                return requestServer();
            } else {
                if(currentPromise) {
                    return currentPromise;
                } else {
                    return requestServer();
                }
            }
        }
        getFetchReponse();
    </script>
</head>
<body>
    <section class="main-content">
        <nav>
            <section class="filtros" id="filtros">
                <select name="" id="">
                    <option value="">Entrada</option>
                    <option value="">Saida</option>
                </select>
                <input type="number">
                <label for="">Valor</label>
                <input type="range" name="" id="">
                <label for="">Data</label>
                <input type="range" name="" id="">
                <select name="" id="">
                    <option value="">Exemplo</option>
                    <option value="">Teste</option>
                    <option value="">Exercicio</option>
                </select>
                <input type="search" name="" id="">
                <button id="btn-click">Atualizar</button>
            </section>
        </nav>
        <main>
            <!-- Tabela Dinamica -->
            <table id="result-transacoes">
                <thead>
                    <tr>
                        <th data-columnref="tipo.nome">Tipo</th>
                        <th data-columnref="descr">Descrição</th>
                        <th data-columnref="valor">Valor</th>
                        <th data-columnref="date">Data</th>
                        <th data-columnref="categoria.nome">Categoria</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>IN</td>
                        <td>Descrição Genérica para estilo</td>
                        <td>R$ 78,90</td>
                        <td>24/02/2024</td>
                        <td>Exemplo</td>
                    </tr>
                    <tr>
                        <td>IN</td>
                        <td>Descrição Genérica para estilo</td>
                        <td>R$ 78,90</td>
                        <td>24/02/2024</td>
                        <td>Exemplo</td>
                    </tr>
                    <tr>
                        <td>IN</td>
                        <td>Descrição Genérica para estilo</td>
                        <td>R$ 78,90</td>
                        <td>24/02/2024</td>
                        <td>Exemplo</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </main>
        <aside>
            <section class="resumo">
                <h2>Resumo</h2>
                <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Esse voluptate, aliquam nisi ducimus, temporibus aut autem rerum iusto, eligendi facere quis excepturi necessitatibus adipisci veniam aspernatur corrupti? Autem, possimus rerum?</p>
                <h3>Conclução</h3>
            </section>
        </aside>
    </section>

    <script id="tr-expand">
        document.addEventListener("DOMContentLoaded", syncAnimatedTable)
        
        function syncAnimatedTable() {
            const trs = document.querySelectorAll('tbody tr');

            trs.forEach(function(tr) {
                const originalHeight = tr.clientHeight;
                const expandedHeight = originalHeight * 1.5; // Altura final ao expandir
                const animationDuration = 350; // Duração da animação em milissegundos
                const increment = (expandedHeight - originalHeight) / (animationDuration / 16); // 16ms é o intervalo de tempo para cada frame (1000ms / 60fps)

                let currentHeight = originalHeight;
                let animationFrameId;
                let isExpanded = false;

                tr.addEventListener('click', function(event) {
                    event.preventDefault();
                    cancelAnimationFrame(animationFrameId);
                    if (isExpanded) {
                        shrink();
                    } else {
                        expand();
                    }
                });

                function expand() {
                    if (currentHeight < expandedHeight) {
                        currentHeight += increment;
                        tr.style.height = currentHeight + 'px';
                        tr.style.fontWeight = 'bold';
                        animationFrameId = requestAnimationFrame(expand);
                    } else {
                        tr.style.height = expandedHeight + 'px';
                        tr.style.fontWeight = 'bold';
                        isExpanded = true;
                    }
                }

                function shrink() {
                    if (currentHeight > originalHeight) {
                        currentHeight -= increment;
                        tr.style.height = currentHeight + 'px';
                        animationFrameId = requestAnimationFrame(shrink);
                    } else {
                        tr.style.height = originalHeight + 'px';
                        tr.style.fontWeight = 'normal';
                        isExpanded = false;
                    }
                }
            });
        };
    </script>

    <script id="JsonTable">
        class JsonTable {
            constructor(data, cabecalhos, tfoot = false) {
                this.data = data;
                this.cabecalhos = cabecalhos;
                this.tfoot = tfoot;
                this.default_data = data;
            }

            renderTable(HtmlTable) {
                const HtmlHeader = HtmlTable.getElementsByTagName('thead')[0];
                const HtmlBody = HtmlTable.getElementsByTagName('tbody')[0];
                const HtmlFoot = HtmlTable.getElementsByTagName('tfoot')[0];

                this.composeHeader(HtmlHeader);
                this.composeBody(HtmlBody);
                this.tfoot ? this.composeFooter(HtmlFoot) : false;
            }

            composeHeader(HtmlHeader) {
                let row = document.createElement('tr');
                HtmlHeader.innerHTML = ''; 

                Object.keys(this.cabecalhos).forEach(key => {
                    let cell = document.createElement('th');
                    cell.setAttribute('data-columnref', key);
                    cell.innerText = this.cabecalhos[key];
                    row.appendChild(cell);
                })

                HtmlHeader.appendChild(row);
            }

            composeBody(HtmlBody) {
                HtmlBody.innerHTML = '';
                this.data.forEach(element => {
                    let row = this.composeBodyRow(element);
                    HtmlBody.appendChild(row);
                });
            }

            composeBodyRow(jrow) {
                let row = document.createElement('tr');
                Object.keys(this.cabecalhos).forEach(key => {
                    let value = Helpers.getNestedPropety(jrow, key);
                    let cell = document.createElement('td');
                    
                    value = Helpers.renderByTypeOf(value, true, 40);
                    cell.innerText = value;
                    row.appendChild(cell);
                })
                return row;
            }

            composeFooter(HtmlFoot) {
                HtmlFoot.innerHTML = '';
                const HtmlFootTr = document.createElement('tr');
                let i = 0;

                Object.keys(this.cabecalhos).forEach(key => {
                    const html_td = document.createElement('td');
                    if (this.isColumnNumerable(key)) {
                        let soma = 0;
                        this.data.forEach(item => {
                            let value = Helpers.getNestedPropety(item, key);
                            soma += Helpers.isNumerable(value) ? parseFloat(value) : 0;
                        })
                        html_td.innerText = Helpers.formatBRL(soma);
                        HtmlFootTr.appendChild(html_td);
                        i++;
                    } else {
                        html_td.innerText = i === 0 ? 'Total' : '';
                        HtmlFootTr.appendChild(html_td);
                        i++;
                    }
                })
                HtmlFoot.appendChild(HtmlFootTr);
            }

            setDefaultData() {
                this.data = this.default_data;
            }

            isColumnNumerable(column) {
                return this.data.some(item => {
                    let value = Helpers.getNestedPropety(item, column);
                    return Helpers.isNumerable(value);
                })
            }
        }
    </script>

    <script>
        class FilterableJsonTable extends JsonTable {

            filterByPath(data, path, filter) {
                const values = [];

                data.forEach(item => {
                    if (Helpers.getNestedPropety(item, path) == filter) {
                        values.push(item);
                    }
                })
                return values;
            }

            static orderByPath(data, path, ord = false) {
                const ord_data = data;
                
                ord_data.sort((a, b) => {
                    let a_value = Helpers.getNestedPropety(a, path); 
                    let b_value = Helpers.getNestedPropety(b, path);
                    let res;

                    if(Helpers.isNumerable(a_value)) {
                        return ord ? a_value - b_value : b_value - a_value;
                    } else if (Helpers.isDateble(a_value)) {
                        if (ord) {
                            res = a_value < b_value ? -1 : a_value > b_value ? 1 : 0;
                            return res;
                        } else {
                            res = a_value > b_value ? -1 : a_value < b_value ? 1 : 0;
                            return res;
                        }
                    } else {
                        return ord ? a_value.localeCompare(b_value) : b_value.localeCompare(a_value);
                    }
                });
                return ord_data;
            }

            static composeFiltros(element = null, search = false) {
                //index
                    //isIndexable?
                        //inputType(type)
                //data
                    //isDatable?
                        //inputType(type)
                //number
                    //isNumerable?
                        //inputType(type)
                //search
                    //searchOn?
                //radio
                    //isRadioOn?
                //checkbox
                    //isCheckboxOn?
                //range
                    //isRangeOn?
                //text range
                    //isTextRangeOn?
                //selec
                    //isSelectOn?
            }

            isIndexable(column) {

            }

            screateFilterElement(type = null) {

            }

            static isNumerable(column, data) {

            }
        }
    </script>

    <script id="Helpers">
        class Helpers {
            static getNestedPropety(obj, path) {
                const keys = path.split('.');
                return keys.reduce((acc, key) => acc[key], obj);
            }

            static isNumerable(value) {
                return (!isNaN(value) && value !== null) ? true : false;
            }

            static isDateble(value) {;
                return (!isNaN(new Date(value).getTime())) ? true : false;
            }

            static renderByTypeOf(value, money = false, str_max_lenght = false) {
                let format_value;

                if(this.isNumerable(value)) {
                    if (money) {
                        format_value = this.formatBRL(parseFloat(value));
                    } else {
                        format_value = parseFloat(value).toFixed(2);
                    }
                } else if(this.isDateble(value)) {
                    format_value = new Date(value).toLocaleDateString();
                     
                } else {
                    if (str_max_lenght) {
                        format_value = this.resumeString(value.trim(), str_max_lenght, true);
                    } else {
                        format_value = value;
                    }
                }
                return format_value;
            }

            static formatBRL(value) {
                return value.toLocaleString('pt-BR', {
                    style: 'currency',
                    currency: 'BRL',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            }

            static resumeString(str, max, cont = false) {
                if(str.length > max) {
                    if (cont) {
                        return str.substring(0, max -3) + "...";
                    } else {
                        return str.sunstring(0, max);
                    }
                }
                return str;
            }

            static sumArray(values) {
                const sum_values = values.reduce((acc, value) => {
                    return acc + parseFloat(value);
                }, 0);
                return sum_values;
            }
        }
    </script>
    
    <script id="tableAdmin">
        document.addEventListener('DOMContentLoaded', function () {
            const myTable = document.querySelector('#result-transacoes');
            const cabecalho = {};

            let tabela;
            let ordAtual = null;
            let ord = true;

            myTable.querySelectorAll('thead th').forEach(item => {
                cabecalho[item.dataset.columnref] = item.innerText;
            });

            function syncAllTable() {
                syncAnimatedTable();
                syncThClick();
            }

            function syncThClick() {
                const html_ths = myTable.querySelectorAll('thead th');
                
                html_ths.forEach(th => {
                    th.addEventListener('click', function() {
                        
                        const coluna = this.dataset.columnref;
                        
                        if (ordAtual === coluna) {
                            ord = !ord;
                        } else {
                            ordAtual = coluna;
                            ord = true;
                        }
                        tabela.data = FilterableJsonTable.orderByPath(tabela.data, coluna, ord);
                        tabela.renderTable(myTable);
                        syncAllTable();
                    })
                })
            }
            
            function refreshTable(refresh_data = false) {
                getFetchReponse(refresh_data).then(data => {
                    tabela = new FilterableJsonTable(data, cabecalho, true);
                    tabela.renderTable(myTable);
                    syncAllTable();
                })
            }
            refreshTable();
        })
    </script>
</body>
</html>